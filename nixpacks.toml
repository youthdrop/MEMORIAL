providers = ["python"]  # Node comes via nixPkgs; avoid npm collisions

[phases.setup]
# Python + virtualenv + Node 20 for the frontend
nixPkgs = ["python311", "python311Packages.virtualenv", "nodejs_20"]

[phases.install]
cmds = [
  # Create project-local virtualenv
  "python -m venv .venv",
  # Install backend deps inside the venv
  "bash -lc 'source .venv/bin/activate && pip install -r backend/requirements.txt'",
  # Install frontend deps
  "cd frontend && npm ci"
]

[phases.build]
cmds = [
  "cd frontend && npm run build"
]

[start]
# Activate venv and start Gunicorn from backend
cmd = "bash -lc 'source .venv/bin/activate && cd backend && gunicorn -w 3 -k gthread -b 0.0.0.0:$PORT app:app'"
