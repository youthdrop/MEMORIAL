providers = ["python"]  # Node is provided via nixPkgs below

[setup]
# Install Python 3.11, virtualenv, and Node 20 for the frontend build
nixPkgs = ["python311", "python311Packages.virtualenv", "nodejs_20"]

[install]
cmds = [
  # Create and use a local virtualenv
  "python -m venv .venv",
  "bash -lc 'source .venv/bin/activate && pip install -r backend/requirements.txt'",
  # Frontend deps
  "cd frontend && npm ci"
]

[build]
cmds = [
  # Build the Vite frontend (outputs to frontend/dist)
  "cd frontend && npm run build"
]

[start]
# Apply migrations each deploy, then start Gunicorn
cmd = "bash -lc 'source .venv/bin/activate && cd backend && FLASK_APP=app.py flask db upgrade && gunicorn -w 3 -k gthread -b 0.0.0.0:$PORT app:app'"
